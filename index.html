<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <title>thmbnlr</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#fff">
    <meta name="Description" content="thmbnlr">

    <style>
        html,input,button {
            font-family: 'Courier New';
            font-style: normal;
            font-weight: 400;
            font-display: fallback;
        }
        .thumbnail {height:300px;padding:20px;float:left;}
        .thumbnail_info {padding:20px;}
        .thumbnail_dump {clear:both; padding:20px;}
        .thumbnail_add {padding:20px;}
    </style>

    <script>
        var info, images = {};
        function request(uri,q,callback) {
            var xmlhttp=null;
            if (window.XMLHttpRequest) {xmlhttp=new XMLHttpRequest()} else {xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")};
            xmlhttp.onreadystatechange=function() { if (xmlhttp.readyState==4) {console.log(xmlhttp.responseText); callback(xmlhttp.responseText)} }
            xmlhttp.open("post",uri,true);
            xmlhttp.setRequestHeader("Content-type","text/plain");
            xmlhttp.send(q);
        }
        function update(url_of_image_to_show) {
            request('info','',function (r) {
                info=JSON.parse(r);
                images=info.thumbnails?JSON.parse(info.thumbnails):undefined;
                if (images&&images.length) {show_thumbs();show_thumbnail(url_of_image_to_show?url_of_image_to_show:images[Math.floor(Math.random()*Math.floor(images.length))].url);}
            })            
        }
        function show_thumbnail(url,force_reload) {
            var force=force_reload?'/'+Math.random():'';
            request('info/'+encodeURIComponent(url),'',function(thumbnail_info){
                thumbnail_info=JSON.parse(thumbnail_info);
                if (thumbnail_info.url)
                {
                    document.getElementById('thmbnlr_thumbnail_info').innerHTML=thumbnail_info.title+'<br><a href='+thumbnail_info.url+'>'+thumbnail_info.url+'</a><p>size: '+thumbnail_info.imagesize+' byte<br>requests: '+thumbnail_info.requests+'<br>age: '+(Math.floor((Date.now()-thumbnail_info.timestamp)/3600000))+'h<p><a href='+encodeURIComponent(url)+'>PNG</a> <a href=info/'+encodeURIComponent(url)+'>JSON</a> <a href=update/'+encodeURIComponent(url)+'>update</a> <a href=remove/'+encodeURIComponent(url)+'>remove</a>';
                    document.getElementById('thmbnlr_thumbnail').innerHTML='<img src='+encodeURIComponent(url)+force+'>';
                }
            });
        }
        function show_thumbs(force_reload) {
            var force=force_reload?'/'+Math.random():'';
            document.getElementById('thmbnlr_dump').innerHTML=images.reduce(function(a,c){return a+='<span style=cursor:pointer onclick=show_thumbnail("'+c.url+'")><img style=height:60px src='+encodeURIComponent(c.url)+force+'></span> '},'')+'<p>'+info.count+' thumbnails, '+info.size+', '+info.requests+' requests';
        }
        function show_add_thumbnail(loading_message) {
            document.getElementById('thmbnlr_add').innerHTML=loading_message||'<form action=javascript:add_thumbnail() method=post><input placeholder="URL with http:// or https://" value="https://"><button type="submit">capture thumbnail</button></form>';
        }
        function add_thumbnail(){
            var url=document.getElementById('url').value;
            show_add_thumbnail('loading '+url+' ...');
            request(encodeURIComponent(url),'',function(){show_add_thumbnail();update(url)});
        }
    </script>
</head>
<body>
    <a href=.><h3>thmbnlr</h3></a>
    <div id=thmbnlr_thumbnail class=thumbnail></div>
    <div id=thmbnlr_thumbnail_info class=thumbnail_info></div>
    <div id=thmbnlr_dump class=thumbnail_dump></div>
    <div class=container><div id=thmbnlr_add class=thumbnail_add></div></div>
    <script>update();show_add_thumbnail();</script>
</body>
</html>
